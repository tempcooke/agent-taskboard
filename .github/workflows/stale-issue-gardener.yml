name: Stale Issue Gardener

on:
  schedule:
    - cron: "0 9 * * 1" # Monday 9am UTC — adjust to your timezone
  workflow_dispatch: # Manual trigger from Actions tab

jobs:
  gardener:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write
    env:
      HAS_MAX_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN != '' && 'true' || 'false' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      # Primary: Use Max subscription (no additional cost)
      - name: Run gardener with Max subscription
        id: max
        if: env.HAS_MAX_TOKEN == 'true'
        continue-on-error: true
        uses: anthropics/claude-code-action@v1
        with:
          allowed_bots: "claude"
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            You are the Stale Issue Gardener. Your job is to keep the issue tracker healthy by managing stale issues, closing abandoned ones, and adding labels to unlabeled issues.

            Use `gh issue list` to find all open issues.

            **Step 1: Mark stale issues (30+ days with no activity)**
            - For issues with no activity in 30+ days that don't already have the `stale` label:
              - Add the `stale` label (create it if it doesn't exist)
              - Post a comment: "This issue has had no activity for 30 days. Is it still relevant? Reply to keep it open, or it will be closed in 30 days."
            - Skip issues labeled `daily-digest`, `agent-health-report`, or `gardener-report`

            **Step 2: Close very stale issues (60+ days with no activity)**
            - For issues already labeled `stale` with no activity in 60+ days:
              - Close them with a comment: "Closing due to 60 days of inactivity. Feel free to reopen if this is still relevant."
            - Skip issues labeled `daily-digest`, `agent-health-report`, or `gardener-report`

            **Step 3: Label recently opened issues with no labels**
            - For issues with no labels that were opened more than 24 hours ago:
              - Read the issue body
              - Apply appropriate labels based on the content (e.g., `bug`, `feature`, `documentation`, `question`, etc.)
              - Create labels if they don't exist
            - Skip issues labeled `daily-digest`, `agent-health-report`, or `gardener-report`
            - Skip issues that are less than 24 hours old

            **Step 4: Create summary report**
            - If you took ANY actions (marked stale, closed, or labeled issues), create a summary issue:
              - Title: "Gardener Report — [today's date YYYY-MM-DD]"
              - Label: `gardener-report` (create if it doesn't exist)
              - Body should contain:
                - How many issues were marked stale
                - How many issues were closed
                - How many issues were labeled
                - List the issue numbers in each category
            - If NO actions were taken, do not create a report issue
          claude_args: "--max-turns 10 --allowedTools 'Bash(gh issue edit:*),Bash(gh issue close:*),Bash(gh issue comment:*),Bash(gh issue create:*),Bash(gh issue list:*),Bash(gh label create:*)' --dangerously-skip-permissions"

      # Check if fallback is actually needed (avoid double-charging on max-turns)
      - name: Check if fallback needed
        id: check_fallback
        if: steps.max.outcome != 'success'
        run: |
          OUTPUT="/home/runner/work/_temp/claude-execution-output.json"
          if [ -f "$OUTPUT" ] && grep -q "error_max_turns" "$OUTPUT" 2>/dev/null; then
            echo "Max hit turn limit after doing work — skipping fallback"
            echo "needed=false" >> $GITHUB_OUTPUT
          else
            echo "needed=true" >> $GITHUB_OUTPUT
          fi

      # Fallback: Use API key (pay-per-token) — only on auth failures, not max-turns
      - name: Fallback to API key
        if: steps.max.outcome != 'success' && steps.check_fallback.outputs.needed != 'false'
        uses: anthropics/claude-code-action@v1
        with:
          allowed_bots: "claude"
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You are the Stale Issue Gardener. Your job is to keep the issue tracker healthy by managing stale issues, closing abandoned ones, and adding labels to unlabeled issues.

            Use `gh issue list` to find all open issues.

            **Step 1: Mark stale issues (30+ days with no activity)**
            - For issues with no activity in 30+ days that don't already have the `stale` label:
              - Add the `stale` label (create it if it doesn't exist)
              - Post a comment: "This issue has had no activity for 30 days. Is it still relevant? Reply to keep it open, or it will be closed in 30 days."
            - Skip issues labeled `daily-digest`, `agent-health-report`, or `gardener-report`

            **Step 2: Close very stale issues (60+ days with no activity)**
            - For issues already labeled `stale` with no activity in 60+ days:
              - Close them with a comment: "Closing due to 60 days of inactivity. Feel free to reopen if this is still relevant."
            - Skip issues labeled `daily-digest`, `agent-health-report`, or `gardener-report`

            **Step 3: Label recently opened issues with no labels**
            - For issues with no labels that were opened more than 24 hours ago:
              - Read the issue body
              - Apply appropriate labels based on the content (e.g., `bug`, `feature`, `documentation`, `question`, etc.)
              - Create labels if they don't exist
            - Skip issues labeled `daily-digest`, `agent-health-report`, or `gardener-report`
            - Skip issues that are less than 24 hours old

            **Step 4: Create summary report**
            - If you took ANY actions (marked stale, closed, or labeled issues), create a summary issue:
              - Title: "Gardener Report — [today's date YYYY-MM-DD]"
              - Label: `gardener-report` (create if it doesn't exist)
              - Body should contain:
                - How many issues were marked stale
                - How many issues were closed
                - How many issues were labeled
                - List the issue numbers in each category
            - If NO actions were taken, do not create a report issue
          claude_args: "--max-turns 10 --allowedTools 'Bash(gh issue edit:*),Bash(gh issue close:*),Bash(gh issue comment:*),Bash(gh issue create:*),Bash(gh issue list:*),Bash(gh label create:*)' --dangerously-skip-permissions"

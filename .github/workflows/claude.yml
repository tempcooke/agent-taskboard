name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned, labeled]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && github.event.action != 'labeled' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude'))) ||
      (github.event_name == 'issues' && github.event.action == 'labeled' && (github.event.label.name == 'planning' || github.event.label.name == 'plan-review' || github.event.label.name == 'ready-to-implement') && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    env:
      HAS_MAX_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN != '' && 'true' || 'false' }}
      PLAN_AGENT_PROMPT: |
        # ROLE
        You are the Plan Agent. You create detailed implementation plans before any code is written.

        # LABEL STATE MACHINE
        You are currently in "planning" mode (label: planning).

        Next states:
        - "plan-review" → Hand off to Review Agent for critique

        # CAPABILITIES
        - Read files: Use Read, Glob, Grep to explore codebase
        - Web search: Use WebSearch to research best practices, libraries, current patterns
        - Manage labels: Use `gh issue edit <NUM> --add-label <LABEL>` and `--remove-label <LABEL>`
        - Add reactions: Use `gh api repos/{owner}/{repo}/issues/comments/{comment_id}/reactions -f content='+1'`

        # YOUR PROCESS
        1. Read the task description in issue body and all comments
        2. If humans have commented, acknowledge by adding ✅ reaction to their comments
        3. Search the web for relevant documentation, libraries, patterns
        4. Read codebase files to understand current architecture
        5. Draft implementation plan including:
           - Approach overview
           - Files to create/modify
           - Step-by-step implementation
           - Risks and edge cases
           - Any clarifying questions
        6. Post your plan as a comment
        7. Transition to review: `gh issue edit <ISSUE_NUM> --remove-label planning --add-label plan-review`

        # HUMAN INTERACTION
        - Humans may comment during your work
        - Add ✅ reaction: `gh api repos/<OWNER>/<REPO>/issues/comments/<COMMENT_ID>/reactions -f content='+1'`
        - Incorporate human feedback into your plan

        # CONSTRAINTS
        - Read-only: NO file edits, NO git operations, NO PR creation
        - Focus on plan quality over speed
        - Use WebSearch extensively - current best practices matter
        - Never skip to implementation - always hand off to Review Agent
        - 50 turn limit: If approaching limit, post your current plan and transition to review

        # TURN MANAGEMENT
        You have 50 turns. Track your progress. If you sense you're running low on turns (>40 turns used):
        - Post whatever plan you have drafted so far
        - Note any incomplete analysis
        - Transition to review anyway: `gh issue edit <ISSUE_NUM> --remove-label planning --add-label plan-review`
        - Review Agent will see your notes and may send back for completion or escalate to human
      REVIEW_AGENT_PROMPT: |
        # ROLE
        You are the Review Agent. You critique plans to catch issues before code is written.

        # LABEL STATE MACHINE
        You are currently in "plan-review" mode (label: plan-review).

        Next states:
        - "planning" → Send back to Plan Agent for revisions
        - "ready-to-implement" → Approve plan, trigger Implementation Agent
        - "needs-human-input" → Escalate after 3 review cycles

        # CAPABILITIES
        - Read files: Use Read, Glob, Grep to verify plan feasibility
        - Web search: Use WebSearch to validate approaches against current best practices
        - Check history: Use `gh api repos/{owner}/{repo}/issues/{number}/events --paginate | jq`
        - Manage labels: Use `gh issue edit <NUM> --add-label <LABEL>` and `--remove-label <LABEL>`
        - Add reactions: Use `gh api repos/{owner}/{repo}/issues/comments/{comment_id}/reactions -f content='+1'`

        # YOUR PROCESS
        1. Read Plan Agent's plan (latest comment before you were triggered)
        2. Read codebase to verify feasibility
        3. Search web to validate:
           - Are libraries/approaches current best practices?
           - Are there better alternatives?
           - Are there known issues?
        4. Check for: security issues, edge cases, performance concerns, architecture mismatches
        5. Count review cycles:
           ```bash
           EVENTS=$(gh api repos/$OWNER/$REPO/issues/$ISSUE_NUM/events --paginate)
           CYCLES=$(echo "$EVENTS" | jq '[.[] | select(.event=="labeled" and .label.name=="plan-review")] | length')
           ```
        6. If CYCLES >= 3:
           - Post: "Plan has been through 3 review cycles. Human decision required. [Summary]"
           - Execute: `gh issue edit <NUM> --remove-label plan-review --add-label needs-human-input`
           - STOP
        7. Decision:
           - If plan needs revision:
             - Post detailed critique
             - Execute: `gh issue edit <NUM> --remove-label plan-review --add-label planning`
           - If plan approved:
             - Post: "Plan approved. Proceeding to implementation."
             - Execute: `gh issue edit <NUM> --remove-label plan-review --add-label ready-to-implement`

        # HUMAN INTERACTION
        - Humans may comment during review
        - Add ✅ reaction to acknowledge: `gh api repos/<OWNER>/<REPO>/issues/comments/<COMMENT_ID>/reactions -f content='+1'`
        - Incorporate human guidance into review

        # CONSTRAINTS
        - Read-only: NO file edits, NO git operations, NO PR creation
        - Be thorough but practical - focus on real risks
        - Use WebSearch to validate every technical decision
        - Be specific in critiques - cite sources when possible
        - 50 turn limit: If approaching limit, escalate to human

        # TURN MANAGEMENT
        You have 50 turns. Track your progress. If you sense you're running low on turns (>40 turns used):
        - Post summary of your review findings so far
        - Explain what still needs review
        - Escalate: `gh issue edit <NUM> --remove-label plan-review --add-label needs-human-input`
        - Post: "Review incomplete due to complexity. Human review required. [Summary of findings]"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
          token: ${{ secrets.PAT_TOKEN }}

      # Initialize new issues with planning label
      - name: Initialize new issues with planning label
        if: github.event_name == 'issues' && github.event.action == 'opened'
        run: |
          ISSUE_NUM="${{ github.event.issue.number }}"

          # Fetch issue data using gh to avoid shell escaping issues
          ISSUE_DATA=$(gh issue view "$ISSUE_NUM" --repo "$GITHUB_REPOSITORY" --json body,title,labels)
          ISSUE_BODY=$(echo "$ISSUE_DATA" | jq -r '.body // ""')
          ISSUE_TITLE=$(echo "$ISSUE_DATA" | jq -r '.title // ""')
          LABEL_COUNT=$(echo "$ISSUE_DATA" | jq '.labels | length')

          # Check if issue mentions @claude
          if echo "$ISSUE_BODY" | grep -q "@claude" || echo "$ISSUE_TITLE" | grep -q "@claude"; then
            if [ "$LABEL_COUNT" -eq 0 ]; then
              echo "New @claude issue detected - adding planning label"
              gh issue edit "$ISSUE_NUM" --add-label planning
            else
              echo "Issue already has labels - skipping auto-label"
            fi
          fi
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      # Ensure labels exist in repository
      - name: Ensure labels exist
        run: |
          gh label create "planning" --color "0052CC" --description "Task needs implementation plan" --force || true
          gh label create "plan-review" --color "FFA500" --description "Plan ready for critique" --force || true
          gh label create "ready-to-implement" --color "00FF00" --description "Plan approved, ready for implementation" --force || true
          gh label create "needs-human-input" --color "FF0000" --description "Agents need human decision" --force || true
          gh label create "claude-working" --color "0969DA" --description "Agent is actively working" --force || true
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      # Detect agent mode based on labels (plan, review, or implement)
      - name: Detect agent mode
        id: mode
        run: |
          ISSUE_NUM=""
          if [ "${{ github.event_name }}" = "issues" ]; then
            ISSUE_NUM="${{ github.event.issue.number }}"
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            ISSUE_NUM="${{ github.event.issue.number }}"
          fi
          if [ -z "$ISSUE_NUM" ]; then
            echo "agent=none" >> $GITHUB_OUTPUT
            exit 0
          fi
          LABELS=$(gh issue view "$ISSUE_NUM" --repo "$GITHUB_REPOSITORY" --json labels --jq '[.labels[].name] | join(",")' 2>/dev/null || echo "")

          # Check labels in priority order
          if echo "$LABELS" | grep -q "ready-to-implement"; then
            echo "agent=implement" >> $GITHUB_OUTPUT
            echo "Agent mode: implement (ready-to-implement label found)"
          elif echo "$LABELS" | grep -q "plan-review"; then
            echo "agent=review" >> $GITHUB_OUTPUT
            echo "Agent mode: review (plan-review label found)"
          elif echo "$LABELS" | grep -q "planning"; then
            echo "agent=plan" >> $GITHUB_OUTPUT
            echo "Agent mode: plan (planning label found)"
          else
            echo "agent=none" >> $GITHUB_OUTPUT
            echo "Agent mode: none (no workflow labels found)"
          fi
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      # Apply working label to indicate agent is actively working
      - name: Apply working label
        run: |
          ISSUE_NUM=""
          if [ "${{ github.event_name }}" = "issues" ]; then
            ISSUE_NUM="${{ github.event.issue.number }}"
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            ISSUE_NUM="${{ github.event.issue.number }}"
          fi
          if [ -n "$ISSUE_NUM" ]; then
            if ! gh label create claude-working --color "0969DA" --description "Agent is actively working" --force; then
              echo "Warning: Failed to create claude-working label"
            fi
            if ! gh issue edit "$ISSUE_NUM" --add-label claude-working; then
              echo "Warning: Failed to apply claude-working label to issue #$ISSUE_NUM"
            fi
          fi
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      # Plan Agent: Create implementation plan (Opus, 50 turns, read-only)
      - name: Run Plan Agent
        id: plan_max
        if: steps.mode.outputs.agent == 'plan' && env.HAS_MAX_TOKEN == 'true'
        continue-on-error: true
        uses: anthropics/claude-code-action@v1
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        with:
          prompt: "Create an implementation plan for issue #${{ github.event.issue.number }} in repository ${{ github.repository }}."
          allowed_bots: "claude"
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.PAT_TOKEN }}
          claude_args: >-
            --model claude-opus-4-6
            --max-turns 50
            --allowedTools "Read,Glob,Grep,WebSearch,Bash(gh issue *),Bash(gh api repos/*/issues/* *)"
            --append-system-prompt "${{ env.PLAN_AGENT_PROMPT }}"

      - name: Run Plan Agent (Fallback)
        if: steps.mode.outputs.agent == 'plan' && (env.HAS_MAX_TOKEN != 'true' || steps.plan_max.outcome != 'success')
        uses: anthropics/claude-code-action@v1
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        with:
          prompt: "Create an implementation plan for issue #${{ github.event.issue.number }} in repository ${{ github.repository }}."
          allowed_bots: "claude"
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.PAT_TOKEN }}
          claude_args: >-
            --model claude-opus-4-6
            --max-turns 50
            --allowedTools "Read,Glob,Grep,WebSearch,Bash(gh issue *),Bash(gh api repos/*/issues/* *)"
            --append-system-prompt "${{ env.PLAN_AGENT_PROMPT }}"

      # Review Agent: Critique plan (Opus, 50 turns, read-only)
      - name: Run Review Agent
        id: review_max
        if: steps.mode.outputs.agent == 'review' && env.HAS_MAX_TOKEN == 'true'
        continue-on-error: true
        uses: anthropics/claude-code-action@v1
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        with:
          prompt: "Review the plan for issue #${{ github.event.issue.number }} in repository ${{ github.repository }}."
          allowed_bots: "claude"
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.PAT_TOKEN }}
          claude_args: >-
            --model claude-opus-4-6
            --max-turns 50
            --allowedTools "Read,Glob,Grep,WebSearch,Bash(gh issue *),Bash(gh api repos/*/issues/* *)"
            --append-system-prompt "${{ env.REVIEW_AGENT_PROMPT }}"

      - name: Run Review Agent (Fallback)
        if: steps.mode.outputs.agent == 'review' && (env.HAS_MAX_TOKEN != 'true' || steps.review_max.outcome != 'success')
        uses: anthropics/claude-code-action@v1
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        with:
          prompt: "Review the plan for issue #${{ github.event.issue.number }} in repository ${{ github.repository }}."
          allowed_bots: "claude"
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.PAT_TOKEN }}
          claude_args: >-
            --model claude-opus-4-6
            --max-turns 50
            --allowedTools "Read,Glob,Grep,WebSearch,Bash(gh issue *),Bash(gh api repos/*/issues/* *)"
            --append-system-prompt "${{ env.REVIEW_AGENT_PROMPT }}"

      # Implementation Agent: Execute approved plan (Sonnet, 50 turns)
      - name: Run Implementation Agent
        id: implement_max
        if: steps.mode.outputs.agent == 'implement' && env.HAS_MAX_TOKEN == 'true'
        continue-on-error: true
        uses: anthropics/claude-code-action@v1
        with:
          allowed_bots: "claude"
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: >-
            --model claude-sonnet-4-5-20250929
            --max-turns 50
            --dangerously-skip-permissions
            --allowedTools "Bash(gh pr create:*),Bash(gh pr edit:*),Bash(gh issue close:*),Bash(gh label create:*)"
            --append-system-prompt "CRITICAL WORKFLOW: You are running in CI with a turn limit. Follow this exact order: 1) Create a working branch and push it immediately. 2) Commit and push after EVERY meaningful change — do NOT batch commits until the end. 3) Create a PR early using gh pr create, even before work is complete, so progress is never lost. 4) Use exactly one label: --label auto-merge, --label needs-review, or --label blocked. Default to needs-review. 5) If triggered from an issue, include Closes #<issue-number> in the PR body. 6) NEVER stop without having committed and pushed your latest changes. 7) If you sense you are running low on turns, immediately commit, push, and ensure the PR exists."

      - name: Run Implementation Agent (Fallback)
        if: steps.mode.outputs.agent == 'implement' && (env.HAS_MAX_TOKEN != 'true' || steps.implement_max.outcome != 'success')
        uses: anthropics/claude-code-action@v1
        with:
          allowed_bots: "claude"
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          claude_args: >-
            --model claude-sonnet-4-5-20250929
            --max-turns 50
            --dangerously-skip-permissions
            --allowedTools "Bash(gh pr create:*),Bash(gh pr edit:*),Bash(gh issue close:*),Bash(gh label create:*)"
            --append-system-prompt "CRITICAL WORKFLOW: You are running in CI with a turn limit. Follow this exact order: 1) Create a working branch and push it immediately. 2) Commit and push after EVERY meaningful change — do NOT batch commits until the end. 3) Create a PR early using gh pr create, even before work is complete, so progress is never lost. 4) Use exactly one label: --label auto-merge, --label needs-review, or --label blocked. Default to needs-review. 5) If triggered from an issue, include Closes #<issue-number> in the PR body. 6) NEVER stop without having committed and pushed your latest changes. 7) If you sense you are running low on turns, immediately commit, push, and ensure the PR exists."

      # Auto-continue: if Claude hit the turn limit AND work is incomplete, post a continuation comment
      - name: Auto-continue on turn exhaustion
        if: always() && steps.mode.outputs.agent == 'implement'
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # Check for turn exhaustion in execution output
          OUTPUT="/home/runner/work/_temp/claude-execution-output.json"
          if [ ! -f "$OUTPUT" ] || ! grep -q "error_max_turns" "$OUTPUT" 2>/dev/null; then
            echo "No turn exhaustion detected — skipping auto-continue"
            exit 0
          fi

          # Determine issue/PR number
          NUM=""
          COMMENT_CMD=""
          if [ "${{ github.event_name }}" = "issue_comment" ] || [ "${{ github.event_name }}" = "issues" ]; then
            NUM="${{ github.event.issue.number }}"
            COMMENT_CMD="gh issue comment"
          elif [ "${{ github.event_name }}" = "pull_request_review_comment" ] || [ "${{ github.event_name }}" = "pull_request_review" ]; then
            NUM="${{ github.event.pull_request.number }}"
            COMMENT_CMD="gh pr comment"
          fi

          if [ -z "$NUM" ]; then
            echo "Could not determine issue/PR number — skipping"
            exit 0
          fi

          # Check if work is already complete before auto-continuing
          # 1. Issue already closed? (Claude may have closed it after finishing)
          ISSUE_STATE=$(gh issue view "$NUM" --repo "${{ github.repository }}" --json state --jq '.state' 2>/dev/null || echo "OPEN")
          if [ "$ISSUE_STATE" = "CLOSED" ]; then
            echo "Issue #${NUM} is already closed — work complete, skipping auto-continue"
            exit 0
          fi

          # 2. PR already created for this issue?
          PR_FOUND=$(gh pr list --repo "${{ github.repository }}" --state open --json body \
            --jq "[.[] | select(.body | contains(\"#${NUM}\"))] | length" 2>/dev/null || echo "0")
          if [ "$PR_FOUND" -gt 0 ]; then
            echo "Open PR already references issue #${NUM} — work complete, skipping auto-continue"
            exit 0
          fi

          # Count existing auto-continue comments (max 2 retries)
          COUNT=$(gh api "repos/${{ github.repository }}/issues/${NUM}/comments" \
            --paginate --jq '[.[] | select(.body | contains("<!-- auto-continue -->"))] | length' 2>/dev/null || echo "0")

          if [ "$COUNT" -ge 2 ]; then
            echo "Already auto-continued ${COUNT} times — stopping to prevent infinite loop"
            exit 0
          fi

          echo "Turn exhaustion detected, work incomplete (auto-continue $((COUNT + 1))/2) — posting continue comment"
          $COMMENT_CMD "$NUM" --repo "${{ github.repository }}" --body "<!-- auto-continue -->
          @claude Continue where you left off. The previous run hit its turn limit. Check for any existing branches or commits you have already made. Complete the remaining work — commit, push, and ensure a PR exists."

      # Remove working label when workflow completes (always run, even on failure)
      - name: Remove working label
        if: |
          always() && (
            github.event_name == 'issues' ||
            github.event_name == 'issue_comment'
          )
        run: |
          ISSUE_NUM=""
          if [ "${{ github.event_name }}" = "issues" ]; then
            ISSUE_NUM="${{ github.event.issue.number }}"
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            ISSUE_NUM="${{ github.event.issue.number }}"
          fi
          if [ -n "$ISSUE_NUM" ]; then
            if ! gh issue edit "$ISSUE_NUM" --remove-label claude-working; then
              echo "Warning: Failed to remove claude-working label from issue #$ISSUE_NUM"
            fi
          fi
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      # Remove workflow labels after implementation completes
      - name: Clean up workflow labels after implementation
        if: |
          success() &&
          steps.mode.outputs.agent == 'implement' &&
          (github.event_name == 'issues' || github.event_name == 'issue_comment')
        run: |
          ISSUE_NUM=""
          if [ "${{ github.event_name }}" = "issues" ]; then
            ISSUE_NUM="${{ github.event.issue.number }}"
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            ISSUE_NUM="${{ github.event.issue.number }}"
          fi
          if [ -n "$ISSUE_NUM" ]; then
            LABELS=$(gh issue view "$ISSUE_NUM" --json labels --jq '[.labels[].name] | join(",")' 2>/dev/null || echo "")

            # Remove ready-to-implement label after implementation completes
            if echo "$LABELS" | grep -q "ready-to-implement"; then
              gh issue edit "$ISSUE_NUM" --remove-label ready-to-implement || true
              echo "Removed ready-to-implement label after implementation completed"
            fi

            # Clean up any stray planning labels
            if echo "$LABELS" | grep -q "planning"; then
              gh issue edit "$ISSUE_NUM" --remove-label planning || true
              echo "Removed planning label"
            fi
            if echo "$LABELS" | grep -q "plan-review"; then
              gh issue edit "$ISSUE_NUM" --remove-label plan-review || true
              echo "Removed plan-review label"
            fi
          fi
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
